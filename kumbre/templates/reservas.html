{% extends 'base.html' %}
{% load static %}
{% block title %}Reservas{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/reservas.css' %}">
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="container">
    <div class="form-box login">
        <form method="POST" id="reservaForm">
            {% csrf_token %}
            <h1>Hacer Reservas</h1>
            
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="input-box">
                <label for="cabana">Cabaña</label>
                <input type="text" id="cabana" name="cabana" class="form-control" 
                       value="{% if cabana %}{{ cabana.nombre }}{% endif %}" readonly>
                <input type="hidden" id="cabana_id" name="cabana_id" 
                       value="{% if cabana %}{{ cabana.id }}{% endif %}">
                <i class='bx bxs-home'></i>
            </div>
            <div class="input-box">
                <label for="precio">Precio Por Pareja</label>
                <input type="text" id="precio" name="precio" class="form-control" readonly> 
                <small id="precio_info" class="form-text text-muted"></small>
                <i class='bx bx-money'></i> 
            </div>
            <div class="input-box">
                <label for="fecha">Fecha</label>
                <input type="text" id="fecha" name="fecha" class="form-control" required> 
                <i class='bx bxs-calendar'></i> 
            </div>
            <div class="input-box">
                <label for="telefono">Teléfono</label>
                <input type="text" id="telefono" name="telefono" class="form-control" required> 
                <i class='bx bxs-phone'></i>
            </div>
            <div class="input-box">
                <label for="numero_personas">Número de Personas</label>
                <input type="number" id="numero_personas" name="numero_personas" class="form-control" required> 
                <i class='bx bxs-envelope'></i>
            </div>
            <button type="submit" class="boton1">Añadir al carrito</button>
        </form>
    </div> 
    <div class="toggle-box">
        <div class="toggle-panel toggle-left">
            <img class="logotipo" src="{% static 'img/logotipo.png' %}" alt="Descripción de la imagen">
        </div>
    </div>
</div>
    
<!-- Cargar jQuery y jQuery UI -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
    $(document).ready(function(){
        // Obtener el cabana_id de la URL o del campo oculto
        const cabanaId = $('#cabana_id').val();
        
        // Obtener la fecha actual
        const today = new Date();
        
        // Inicializar el Datepicker en el campo "fecha"
        $("#fecha").datepicker({
            dateFormat: "yy-mm-dd",
            minDate: new Date(), // Establece la fecha mínima como hoy
            beforeShowDay: function(date) {
                // Formato de fecha para comparación
                let y = date.getFullYear();
                let m = ("0" + (date.getMonth() + 1)).slice(-2);
                let d = ("0" + date.getDate()).slice(-2);
                let dateString = y + '-' + m + '-' + d;
                
                // Si existen fechas ocupadas, deshabilitarlas
                if(window.fechasOcupadas && window.fechasOcupadas.indexOf(dateString) !== -1){
                    return [false, "ocupado", "Fecha ocupada"];
                }
                
                return [true, "", ""];
            },
            // Mejora del diseño del calendario
            showOtherMonths: true,
            selectOtherMonths: true,
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            showOn: "both",
            buttonText: "",  // Texto vacío para evitar el problema
            dayNamesMin: ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"],
            monthNamesShort: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
            monthNames: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
            // Cuando se selecciona una fecha
            onSelect: function(dateText) {
                // Solo consultar precio si hay una cabaña seleccionada
                if (cabanaId) {
                    actualizarPrecio(cabanaId, dateText);
                }
            }
        });
        
        function actualizarPrecio(cabanaId, fecha) {
            $.ajax({
                url: '{% url "calcular_precio" %}',
                method: 'GET',
                data: {
                    cabana_id: cabanaId,
                    fecha: fecha
                },
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        // Actualizar el precio en el formulario
                        $("#precio").val(data.precio.toFixed(2));
                        
                        // Mostrar información sobre el tipo de día
                        let tipoDia = "";
                        switch(data.tipo_dia) {
                            case 'festivo':
                                tipoDia = "Precio para día festivo";
                                break;
                            case 'fin_semana':
                                tipoDia = "Precio para fin de semana";
                                break;
                            case 'entre_semana':
                                tipoDia = "Precio para día entre semana";
                                break;
                        }
                        $("#precio_info").text(tipoDia);
                    } else {
                        alert("Error al calcular el precio: " + data.error);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error al consultar el precio:", error);
                    alert("Error al consultar el precio. Por favor, intente de nuevo.");
                }
            });
        }
        
        // Si hay cabanaId, se hace una petición AJAX para obtener las fechas ocupadas
        if(cabanaId) {
            $.ajax({
                url: '/fechas_ocupadas/' + cabanaId + '/',
                method: 'GET',
                dataType: 'json',
                success: function(data){
                    window.fechasOcupadas = data.fechas_ocupadas;
                    $("#fecha").datepicker("refresh");
                },
                error: function(){
                    console.error("Error al obtener las fechas ocupadas.");
                }
            });
        }

        
        
        // Validación del formulario antes de enviar
        $("#reservaForm").on('submit', function(e) {
            const fecha = $("#fecha").val();
            const precio = $("#precio").val();
            
            if (!fecha) {
                alert("Por favor, seleccione una fecha para la reserva.");
                e.preventDefault();
                return false;
            }
            
            if (!precio) {
                alert("El precio no ha sido calculado. Por favor, seleccione una fecha válida.");
                e.preventDefault();
                return false;
            }
            
            return true;
        });
    });
</script>
{% endblock %}